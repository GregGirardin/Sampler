<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sample Player</title>
<style>

.css_librarySample
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_librarySample:hover { border: 2px solid black; }

.css_slSample
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_menuButton
{
  border: 2px solid white;
  background-color: #ddf;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_menuButton:hover { border: 2px solid black; }

.css_modeButton
{
  border: 2px solid white;
  background-color: #bbf;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_modeButton:hover { border: 2px solid black; }

.css_FSButton
{
  border: 2px solid white;
  background-color: #bbf;
  color: #444;
  padding: 6px;
  text-align: denter;
  font-size: 14px;
}

.css_FSButton:hover { border: 2px solid black; }

.css_groupClass
{
  background-color: #ddf;
  color: #000;
  text-align: center;
  font-size: 16px;
  border: 0px solid black;
}

.css_Clipboard
{
  border: 1px solid black;
  background-color: #fff;
  color: #000;
  padding: 2px;
  text-align: center;
  font-size: 16px;
}

#sampleListName { font-size: 20px; }

.css_groupSeqNext
{
  position:relative;
  overflow:hidden;
  background: #bbf;
  clip-path: polygon( 0% 0%, 85% 0, 100% 50%, 85% 100%, 0% 100% );
}

.css_groupSeqCont
{
  position:relative;
  overflow:hidden;
  background: #ccf;
  clip-path: polygon( 0% 0%, 85% 0, 100% 50%, 85% 100%, 0% 100%, 10% 50% );
}

.css_playing
{
  position:relative;
  overflow:hidden;
  background: #ccf;
  clip-path: polygon( 0% 0%, 85% 0, 100% 50%, 85% 100%, 0% 100%, 10% 50% );
}

.css_pending 
{
  position:relative;
  overflow:hidden;
  font-style: italic;
  color: #f00;
}


.css_highlight_red { background-color: #f00; }
.css_cursor { background-color: #faa; }

.css_topButtons
{
  background-color: #fdd;
  padding: 10px;
  font-size: 16px;
}

.css_sampleList_pane
{
  align-items: left;
  margin: 0;
  padding: 0;
  width: 49.5%;
  background-color: #f1f1f1;
  height: 50%;
  overflow: auto;
  border: 1px solid black;
  float: left
}

.css_library_pane
{
  align-items: left;
  margin: 0;
  padding: 0;
  width: 49.5%;
  background-color: #f1f1f1;
  border: 1px solid black;
  float: right
}

.css_library
{
  overflow: scroll;
  height: 90vh;
}

.css_editSample
{
  padding: 10px;
  font-size: 14px;
  text-align: left;
  background-color: #ddf;
  border: 1px solid black;
  font-family: "Lucida Console", "Courier New", monospace;
}

.slider
{
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover
{
  opacity: 0;
}

.slider::-webkit-slider-thumb
{
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  background: #04AA6D;
  cursor: pointer;
}

.slider::-moz-range-thumb
{
  width: 25px;
  height: 25px;
  background: #04AA6D;
  cursor: pointer;
}

#trashCan
{
  display: block;
  height: 40px;  
  width: 30px;
}

</style>
</head>
<body align="left">
<section>
<div id='samplesPane' class='css_sampleList_pane'>
<input contenteditable='true' id='serverURL' value='URL'>
<button class='css_menuButton' id='saveConfigButton'    onclick='saveSampleConfig();'>Save</button>
<button class='css_modeButton' id='modeEditButton'      onclick='changeMode( "Mode_Edit" );'>Edit</button>
<button class='css_modeButton' id='Help'                onclick='toggleHelp();'>Help</button>
<hr>
<div id='footSwitchButtons' align='left'>
Tap
<button class='css_FSButton' id='fsB1Tap' onclick='buttonEvent( "EVENT_TAP", "BUTTON1" );'>&larr;</button>
<button class='css_FSButton' id='fsB2Tap' onclick='buttonEvent( "EVENT_TAP", "BUTTON2" );'>&rarr;</button>
<button class='css_FSButton' id='fsBBTap' onclick='buttonEvent( "EVENT_TAP", "BUTTONB" );'>Both</button>
Hold
<button class='css_FSButton' id='fsB1Hold' onclick='buttonEvent( "EVENT_HOLD", "BUTTON1" );'>&uarr;</button>
<button class='css_FSButton' id='fsB2Hold' onclick='buttonEvent( "EVENT_HOLD", "BUTTON2" );'>&darr;</button>
<button class='css_FSButton' id='fsBBHold' onclick='buttonEvent( "EVENT_HOLD", "BUTTONB" );'>Both</button>
Double Tap
<button class='css_FSButton' id='fsB1DTap' onclick='buttonEvent( "EVENT_DTAP", "BUTTON1" );'>&#62;</button>
<button class='css_FSButton' id='fsB2DTap' onclick='buttonEvent( "EVENT_DTAP", "BUTTON2" );'>&#8800;</button>
<hr>
</div>
<div id='setlist'> </div>
<div id='multiuse'></div>
</div><form action="" method="get"></form>

<div id='library_pane' class='css_library_pane'>
<hr>
<div id='libraryDiv' class='css_library'> </div>
</div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

var serverURL = 'http://192.168.0.2:8080/'; // this is where samples.json and all the samples live.
// var serverURL = 'https://greggirardin.github.io/samples/';
var configFile = 'sampleConfig.json';

// Can specify in URL. https://setlist.loc.com/?serverURL='https://your.samples.loc/path/to/stuff'
var slEditedFlag = false;
var sampleLibrary = {}; // object of ClLibrarySample
var audioFiles = {}; // object of audio file binaries
var curSampleConfig;
var editSample; // What we're editing if "Mode_Edit"
var editGroup;
var didNavFlag = false;

// Constants.
const MAX_GROUPS = 10;
const samplePollTime = 100;

var operationMode = "Mode_Default";
var fsMode = "PM"; 
var cursorGroup = 0, cursorSample = 0; // cursor

//////////////////////////// //////////////////////////// ////////////////////////////
class CLibrarySample
{
  constructor( filename )
  {
    this.filename = filename;
  }
}

var loopTypes = [ "Once", "Repeat" ];
var seqTypes = [ "Single", "Next", "Play" ];

class CSample
{
  constructor( filename )
  {
    this.displayName = filename;
    this.filename = filename; // filename on the server.
    this.highlight = false;
    this.medley = false;
    this.fadeInTime = 0; // Milliseconds
    this.fadeOutTime = 0;
    this.loopType = loopTypes[ 0 ];
    this.volume = 100;
  }
}

class CGroup
{
  constructor( name )
  {
    this.name = name;
    this.seqType = "None"; // None, Single, Loop
    this.samples = []; // Sample[]
  }
}

class CSampleConfig
{
  constructor( sampListName )
  {
    this.name = sampListName;
    this.sampleBaseURL = undefined; // The prefix of the path to all the samples
    this.groups = [];
    this.groups.push( new CGroup( "Group" ) );
    this.groups.push( new CGroup( "Clipboard" ) );
  }
}

//////////////////////////// ////////////////////////////
//////////////////////////// ////////////////////////////
window.onload = sampleListInit;

function changeURL()
{
  serverURL = document.getElementById( 'serverURL' ).value;
}

/////////////// /////////////// /////////////// ///////////////
function sampleListInit()
{
  const urlParams = new URLSearchParams( window.location.search );
  var server = urlParams.get( 'serverURL' );
  if( server ) // Server URL provided by user
    serverURL = server;

  newSampleConfig();
  getFileFromServer( "samples.json", gotSamples, false );
  getFileFromServer( configFile, gotConfig, false );

  document.getElementById( 'serverURL' ).value = serverURL;
  document.getElementById( 'serverURL' ).addEventListener( 'change', changeURL, false );

  document.addEventListener( 'keydown', keyPressedHandler );
  document.addEventListener( 'keyup', keyRelHandler );

  footSwitchButtons[ 0 ] = new FootSwitchButton( "BUTTON1" );
  footSwitchButtons[ 1 ] = new FootSwitchButton( "BUTTON2" );
  //setInterval( genPurposeTimer, samplePollTime );
}

// function genPurposeTimer()
// {
//   for( var i = 0;i < curSampleConfig.groups.length;i++ )
//   {
//     var g = curSampleConfig.groups[ i ];
//     for( var j = 0;j < g.samples.length;j++ )
//       if( g.samples[ j ].remainingTime > 0 )
//       {
//         g.samples[ j ].remainingTime -= samplePollTime;
//         if( g.samples[ j ].remainingTime <= 0 )
//         {
//           audioFiles[ g.samples[ j ].filename ].pause();
//           var elem = document.getElementById( "slSample." + i + "." + j );
//           elem.classList.remove( 'css_playing' );
//           if( ( g.seqType == seqTypes[ 2 ] ) && !didNavFlag ) // in Continuous mode and haven't navigated.
//             playSample( "START" );
//         }
//       }
//   }
// }

var curAF; // current audio being played.

function stopAudio()
{
  if( curAF )
  {
    var elem = document.getElementById( curAF.sampleObj.id );
    elem.classList.remove( 'css_playing' );
    curAF.pause();
    curAF = undefined;
  }
}

function playEnded()
{
  var playNext = curAF.sampleObj.playNext && !didNavFlag;
  stopAudio();
  if( playNext )
    playSample( "START" );
}

function playSample( status )
{
  stopAudio();

  if( ( cursorGroup != undefined ) && ( cursorSample != undefined ) && status == "START" )
  {
    var cs = curSampleConfig.groups[ cursorGroup ].samples[ cursorSample ];

    curAF = audioFiles[ cs.filename ];
    curAF.currentTime = 0; // start from the beginning

    if( cs.loopType == "Once" )
    {
      curAF.loop = false;
      curAF.onended = playEnded;
    }
    else
      curAF.loop = true;

    curAF.play();

    cs.id = "slSample." + cursorGroup + "." + cursorSample;
    var elem = document.getElementById( cs.id );
    elem.classList.add( 'css_playing' );

    if( curSampleConfig.groups[ cursorGroup ].seqType == seqTypes[ 2 ] )
      cs.playNext = true;
    else
      cs.playNext = false;

    curAF.sampleObj = cs;

    if( ( curSampleConfig.groups[ cursorGroup ].seqType == seqTypes[ 1 ] ) ||
        ( curSampleConfig.groups[ cursorGroup ].seqType == seqTypes[ 2 ] ) )
    {
      moveCursor( "RIGHT" );
      didNavFlag = false;
    }
  }
}

///////////////////////// /////////////////////////
///////////////////////// /////////////////////////
/* Foot switch handling for two buttons. Assume the buttons are mapped to UP and DOWN.
   8 functions: Tap L+R, Double Tap L+R, Hold L+R, Both Tap, Both hold

          | Start Timer       clickHoldTO
  Time -----------------------|   Trigger Hold at 'up' for determinism.
    ______/-------------------|---\_ Hold
    ______/----------\________| Single Tap
    ______/--\___/-| Double Tap 
          ^--- Button pressed
*/
const clickHoldTO = 250;

var footSwitchButtons = []; // array of buttons
var bothHeldTimer;

var fsMode = "PM"; // Play Mode

var fsButtonMap = 
{
  "EVENT_TAP" : {
    "BUTTON1" : {
      id : 'fsB1Tap', // the DOM element to flash
      PM : { html : "&larr;", action : function() { moveCursor( 'LEFT' ); } },
      DM : { html : "", action : function() { } }
    },
    "BUTTON2" : {
      id : 'fsB2Tap',
      PM : { html : "&rarr;", action : function() { moveCursor( 'RIGHT' ); } },
      DM : { html : "", action : function() { } }
    },
    "BUTTONB" : { 
      id : 'fsBBTap',
      PM : { html : "NA", action : function() { } },
      DM : { html : "NA", action : function() { } } 
    },
  },

  "EVENT_DTAP" : {
    "BUTTON1" : {
      id : 'fsB1DTap',
      PM : { html : "&#62;", action : function() { playSample( 'START' ); } },
      DM : { html : "&#62;", action : function() { playSample( 'START' ); } }
    },
    "BUTTON2" : {
      id : 'fsB2DTap',
      PM : { html : "#8800;", action : function() { playSample( 'STOP' ) } },
      DM : { html : "#8800;", action : function() { playSample( 'STOP' ) } }
    },
  },

  "EVENT_HOLD" : {
    "BUTTON1" : {
      id : 'fsB1Hold',
      PM :  { html : "&uarr;", action : function() { moveCursor( 'UP' ); } }, 
      DM :  { html : "#8800;", action : function() { moveCursor( 'UP' ); } }
    },
    "BUTTON2" : {
      id : 'fsB2Hold',
      PM : { html : "&darr;", action : function() { moveCursor( 'DOWN' ); } },
      DM : { html : "#8800;", action : function() { moveCursor( 'DOWN' ); } }
    },
    "BUTTONB" : {
      id : 'fsBBHold',
      PM : { html : "Play", action : function() { togglePlayMode(); } },
      DM : { html : "Direct", action : function() { togglePlayMode(); } }
    },
  }
};

function togglePlayMode()
{
  var elem = document.getElementById( 'fsBBHold' );

  if( fsMode == "PM" )
  {
    fsMode = "DM"; // direct mode
    elem.innerHTML = "Direct";
  }
  else
  {
    fsMode = "PM"; // play mode
    elem.innerHTML = "Play";
  }
}

function moveCursor( dir )
{
  switch( dir )
  {
    case 'UP':
      if( cursorGroup > 0 )
        cursorGroup -= 1;
      break;

    case 'DOWN':
      if( cursorGroup < curSampleConfig.groups.length - 2 )
        cursorGroup += 1;
      break;

    case 'LEFT':
      if( cursorSample > 0 )
        cursorSample -= 1;
      break;

    case 'RIGHT':
      cursorSample += 1;
      if( cursorSample > curSampleConfig.groups[ cursorGroup ].samples.length - 1 )
        cursorSample = 0;
      break;
  }
  didNavFlag = true; // navigating stops the continuous playing of a sequence.
  genSampleConfigHTML();
}

function buttonEvent( event, buttonID )
{
  fsButtonMap[ event ][ buttonID ][ fsMode ].action();
  var elem = document.getElementById( fsButtonMap[ event ][ buttonID ].id );
  elem.classList.add( 'css_highlight_red' );
  setTimeout( buttonHLTimer, 100 );
}

function buttonHLTimer()
{
   var buttons = document.getElementsByClassName( 'css_FSButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'css_highlight_red' );
}

function bothHoldTimerCB() // Both buttons were held.
{
  bothHeldTimer = undefined; // clear. It's used as a flag below.
  buttonEvent( "EVENT_HOLD", "BUTTONB" );
  footSwitchButtons[ 0 ].pressedState = false;
  footSwitchButtons[ 1 ].pressedState = false;
}

class FootSwitchButton
{
  constructor( identifier )
  {
    this.buttonID = identifier;
    this.buttonState = false;
    this.heldFlag = false;
    this.pressedState = false;
    this.holdTimer = undefined;
    this.holdTimerExpired = false;
  }

  clearTimer()
  {
    clearTimeout( this.holdTimer );
    this.holdTimer = undefined;
  }

  setState( newState )
  {
    if( newState != this.buttonState )
    {
      this.buttonState = newState;

      if( newState ) // true = 'down'
      {
        // Check for both buttons pressed
        var otherButtonIx = ( this.buttonID == "BUTTON1" ) ? 1 : 0;
        if( footSwitchButtons[ otherButtonIx ].buttonState ) // both pressed ?
        {
          this.clearTimer(); // clear existing timers and set the 'both' timer.
          footSwitchButtons[ otherButtonIx ].clearTimer();
          bothHeldTimer = setTimeout( bothHoldTimerCB, clickHoldTO );
        }
        else
        {
          if( !this.pressedState ) 
          { // first click
            this.heldFlag = true;
            this.pressedState = true; 
            this.holdTimer = setTimeout( holdTimerCB, clickHoldTO, this.buttonID );
          }
          else 
          { // this is the second click.
            this.clearTimer();
            this.pressedState = false;
            buttonEvent( "EVENT_DTAP", this.buttonID );
          }
        }
      }
      else // up
      {
        if( this.holdTimerExpired )
        {
          buttonEvent( "EVENT_HOLD", this.buttonID );
          this.holdTimerExpired = false;
        }
        else if( bothHeldTimer ) // both aren't pressed but they were previously
        {
          var otherButtonIx = ( this.buttonID == "BUTTON1" ) ? 1 : 0;
          clearTimeout( bothHeldTimer );
          bothHeldTimer = undefined;
          this.clearTimer();
          this.pressedState = false; 

          footSwitchButtons[ otherButtonIx ].clearTimer();
          footSwitchButtons[ otherButtonIx ].pressedState = false;
          buttonEvent( "EVENT_TAP", "BUTTONB" );
        }
        this.heldFlag = false;
      }
    }
  }

  holdTimerCB()
  {
    this.pressedState = false;
    this.holdTimer = undefined;

    if( !this.heldFlag )
      buttonEvent( "EVENT_TAP", this.buttonID );
    else
    {
      // highlight hold when the timer expires so user knows release will trigger the event.
      var elem = document.getElementById( fsButtonMap[ "EVENT_HOLD" ][ this.buttonID ].id );
      elem.classList.add( 'css_highlight_red' );
      this.holdTimerExpired = true;
    }
  }
}

// TBD. Call class method directly?
function holdTimerCB( ButtonID )
{
  footSwitchButtons[ ( ButtonID == "BUTTON1" ) ? 0 : 1 ].holdTimerCB();
}

function keyHandler( e, state )
{
  var ix;

  switch( e.code )
  {
    case 'ArrowLeft':
    case 'ArrowUp':   ix = 0; break;
    case 'ArrowRight':
    case 'ArrowDown': ix = 1; break;
    default: return;
  }
  footSwitchButtons[ ix ].setState( state );
}

function keyPressedHandler( e ) { keyHandler( e, true ); } // down / pressed
function keyRelHandler( e ) { keyHandler( e, false ); } // up / released

///////////////////////// ///////////////////////// /////////////////////////
///////////////////////// ///////////////////////// /////////////////////////
function gotSamples( file, data )
{
  sampleLibrary = JSON.parse( data );
  generateLibraryHTML();
}

function gotConfig( file, data )
{
  curSampleConfig = JSON.parse( data );

  getSampleAudio();
  genSampleConfigHTML();
}

function getSampleAudio()
{
  for( g = 0;g < curSampleConfig.groups.length;g++ )
  {
    var sList = curSampleConfig.groups[ g ].samples;
    for( s = 0;s < sList.length;s++ )
      if( audioFiles[ sList[ s ].filename ] == undefined )
        audioFiles[ sList[ s ].filename ] = new Audio( serverURL + sList[ s ].filename );
  }
}

function getFileFromServer( filename, callback, binaryFlag )
{
  console.log( "Get: " + filename );
  var xhr = new XMLHttpRequest();

  if( binaryFlag )
  {
    xhr.open( "GET", serverURL + filename, true );
    xhr.responseType = 'blob';
    xhr.onload = function( e ) {
      if ( xhr.readyState === 4 )
        if( xhr.status == "200" )
          callback( filename, xhr.response );
        else
          callback( filename, false ); // Error, file not present probably.
    }
    xhr.onerror = function( e ) {
      callback( filename, false );
    }
    xhr.ontimeout = function( e ) {
      callback( filename, false );
    }
  }
  else
  {
    xhr.overrideMimeType( "application/json" );
    xhr.open( "GET", serverURL + filename, true );
    xhr.onreadystatechange = function() {
      if ( xhr.readyState === 4 )
        if( xhr.status == "200" )
          callback( filename, xhr.responseText );
        else
          callback( filename, false ); // Error, file not present probably.
    }
    xhr.onerror = function( e ) {
      callback( filename, false );
    }
    xhr.ontimeout = function( e ) {
      callback( filename, false );
    }
  }

  xhr.send( null );
}

function sl_allowDrop( ev ) { ev.preventDefault(); }
function dragElem( ev ) { ev.dataTransfer.setData( "dragElem", ev.target.id ); }

/////////////// /////////////// /////////////// ///////////////
// Handle a song being dropped onto a setlist file.
// Samples can be dragged from within the setlist to move them or from the Library to add them.
/////////////// /////////////// /////////////// ///////////////
function dropElem( ev )
{
  const slSample = "slSample.";
  const slGroup = "slGroup.";
  const cbStr = "clipboard";
  const lSamp = "libSample.";

  ev.preventDefault();
  var dragElem = ev.dataTransfer.getData( "dragElem" );

  if( ( dragElem.substring( 0, cbStr.length ) == cbStr ) &&
      ( ev.target.id.substring( 0, slSample.length ) == slSample ) ) // dropping the clipboard onto a set.
  {
    indexes = ev.target.id.substring( slSample.length, ).split( "." );
    var toGroup = parseInt( indexes[ 0 ] );
    var toSampleIx = parseInt( indexes[ 1 ] );

    if( toGroup < curSampleConfig.groups.length - 1 )
      while( true )
      {
        var song = curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples.pop();
        if( song )
          curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, song );
        else
          break;
      }
  }
  else if( ( dragElem.substring( 0, slSample.length ) == slSample ) &&
           ( ev.target.id.substring( 0, slSample.length ) == slSample ) ) // Moving a sample
  {
    var indexes = dragElem.substring( slSample.length, ).split( "." );
    var fromGroup = parseInt( indexes[ 0 ] );
    var fromSampleIx = parseInt( indexes[ 1 ] );

    indexes = ev.target.id.substring( slSample.length, ).split( "." );
    var toGroup = parseInt( indexes[ 0 ] );
    var toSampleIx = parseInt( indexes[ 1 ] );

    if( fromGroup == toGroup ) // Moving within the same set
    {
      if( toSampleIx < fromSampleIx ) // Moved song up
      {
        curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, curSampleConfig.groups[ fromGroup ].samples[ fromSampleIx ] );
        curSampleConfig.groups[ fromGroup ].samples.splice( fromSampleIx + 1, 1 );
      }
      else
      {
        curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx + 1, 0, curSampleConfig.groups[ fromGroup ].samples[ fromSampleIx ] );
        curSampleConfig.groups[ fromGroup ].samples.splice( fromSampleIx, 1 );
      }
    }
    else // Move between groups.
    {
      curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, curSampleConfig.groups[ fromGroup ].samples[ fromSampleIx ] );
      curSampleConfig.groups[ fromGroup ].samples.splice( fromSampleIx, 1 );
    }
  }
  else if( ( dragElem.substring( 0, lSamp.length ) == lSamp ) &&
           ( ev.target.id.substring( 0, slSample.length ) == slSample ) ) // Dropping library song into set list.
  {
    var sampId = dragElem.substring( lSamp.length, );
    var libSample = sampleLibrary[ sampId ];
    var indexes = ev.target.id.substring( slSample.length, ).split( "." );
    var toGroup = parseInt( indexes[ 0 ] );
    var toSampleIx = parseInt( indexes[ 1 ] );

    curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, new CSample( libSample.filename ) );
    getSampleAudio(); // get any new audio.
  }
  else if( ( dragElem.substring( 0, slGroup.length ) == slGroup ) &&
           ( ev.target.id.substring( 0, slGroup.length ) == slGroup ) ) // Moving a group
  {
    var fromGroup = parseInt( dragElem.substring( slGroup.length, ) );
    var toGroup = parseInt( ev.target.id.substring( slGroup.length, ) );

    if( toGroup < fromGroup ) // moved group up
    {
      curSampleConfig.groups.splice( toGroup, 0, curSampleConfig.groups[ fromGroup ] );
      curSampleConfig.groups.splice( fromGroup + 1, 1 );
    }
    else
    {
      curSampleConfig.groups.splice( toGroup + 1, 0, curSampleConfig.groups[ fromGroup ] );
      curSampleConfig.groups.splice( fromGroup, 1 );
    }
  }
  else if( ev.target.id == "trashCan" )
  {
    if( dragElem.substring( 0, slSample.length ) == slSample )
    {
      var indexes = dragElem.substring( slSample.length, ).split( "." );
      var delGroup = parseInt( indexes[ 0 ] );
      var delSample = parseInt( indexes[ 1 ] );

      curSampleConfig.groups[ delGroup ].samples.splice( delSample, 1 );
    }
    else if( dragElem.substring( 0, slGroup.length ) == slGroup )
    {
      var delGroup = parseInt( dragElem.substring( slGroup.length, ) );
      curSampleConfig.groups.splice( delGroup, 1 );
    }
    else if( dragElem.substring( 0, cbStr.length ) == cbStr )
      curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples = [];
  }

  slEditedFlag = true;

  genSampleConfigHTML();
}

/////////////// /////////////// /////////////// ///////////////
function setSampleConfigName()
{
  var name = prompt( "Enter Sample File Name:", curSampleConfig.name );
  if( name )
  {
    curSampleConfig.name = name;
    slEditedFlag = true;
    genSampleConfigHTML();
  }
}

/////////////// /////////////// /////////////// ///////////////
function groupClick( groupIndex )
{
  if( operationMode == "Mode_Edit" )
  {
    saveEdits();
    editSample = undefined;
    editGroup = curSampleConfig.groups[ groupIndex ];
  }

  genSampleConfigHTML();
}

/////////////// /////////////// ///////////////
function sampleClick( groupIndex, sampleIndex )
{
  var cs = curSampleConfig.groups[ groupIndex ].samples[ sampleIndex ];

  saveEdits();

  if( ( cursorGroup != groupIndex ) && ( cursorSample != sampleIndex ) )
    didNavFlag = true;

  cursorGroup = groupIndex;
  cursorSample = sampleIndex;

  if( operationMode == "Mode_Highlight" )
    cs.highlight = !cs.highlight;
  else if( operationMode == "Mode_Medley" )
    cs.medley = !cs.medley;
  else if( operationMode == "Mode_Edit" )
  {
    editGroup = undefined;
    editSample = cs;
  }
  genSampleConfigHTML(); 
}

/////////////// /////////////// /////////////// ///////////////
function libSampleClick( songId )
{
  sample = new CSample( sampleLibrary[ songId ].filename );
  curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples.push( sample ); // add to Clipboard
  genSampleConfigHTML();
}

/////////////// /////////////// /////////////// ///////////////
function newSampleConfig()
{
  if( slEditedFlag )
    if( !window.confirm( "Unsaved Edits. Continue?" ) )
      return;

  slEditedFlag = false;
  curSampleConfig = new CSampleConfig( "Sample List" );

  genSampleConfigHTML();
}

/////////////// /////////////// /////////////// ///////////////
function groupAdd()
{
  if( curSampleConfig.groups.length < MAX_GROUPS )
  {
    curSampleConfig.groups.splice( curSampleConfig.groups.length - 1, 0, new CGroup( "Group" ) );
    slEditedFlag = true;
    genSampleConfigHTML();
  }
  else
    alert( "Max Groups reached" );
}

/////////////// /////////////// /////////////// ///////////////
function genSampleConfigHTML()
{
  if( operationMode == "Mode_Edit" )
  {
    var tmpHtml = "<hr>";

    if( editSample )
    {
      tmpHtml += "Display Name: <input contenteditable='true' id='editSampleName' value='" + editSample.displayName + "'><br>";
      tmpHtml += "File: " + editSample.filename + "<br>";
      tmpHtml += "Volume: <input type='range' id='editSampleVolume' min='0' max='100' value='" + editSample.volume + "'><br>";
      tmpHtml += "Fade In: <input type='range' id='editSampleFIT' min='0' max='5000' value='" + editSample.fadeInTime + "'><br>";
      tmpHtml += "Fade Out: <input type='range' id='editSampleFOT' min='0' max='5000' value='" + editSample.fadeOutTime + "'><br>";
      tmpHtml += "Audio Length: " + ( audioFiles[ editSample.filename ].duration * 1000 ).toString().split('.')[ 0 ] + "ms<br>";
      tmpHtml += "Play:<select id='editSamplePT'>";

      for( var i = 0;i < loopTypes.length;i++ )
      {
        tmpHtml += "<option value='" + loopTypes[ i ] + "' ";
        if( editSample.loopType == loopTypes[ i ] )
          tmpHtml += "selected='selected'";
        tmpHtml += ">" + loopTypes[ i ] + "</option>";
      }
      tmpHtml += "</select><br>";
    }
    else if( editGroup )
    {
      tmpHtml += "Name: <input contenteditable='true' id='editGroupName' value='" + editGroup.name + "'><br>";
      tmpHtml += "Sequence:<select id='editGroupSequence'>";
      for( var i = 0;i < seqTypes.length;i++ )
      {
        tmpHtml += "<option value='" + seqTypes[ i ] + "' ";
        if( editGroup.seqType == seqTypes[ i ] )
          tmpHtml += "selected='selected'";
        tmpHtml += ">" + seqTypes[ i ] + "</option>";
      }
      tmpHtml += "</select><br>";
    }

    document.getElementById( 'multiuse' ).innerHTML = tmpHtml;
  }

  var l = curSampleConfig.groups.length;
  if( l == 1 )
    cursorGroup = undefined;
  else
  {
    if( cursorGroup == undefined )
      cursorGroup = 0;
    if( cursorGroup >= l - 1 )
      cursorGroup = l - 2;
    l = curSampleConfig.groups[ cursorGroup ].samples.length;
    if( cursorSample >= l )
      cursorSample = l - 1;
    else if( ( cursorSample < 0 ) && ( l > 0 ) )
      cursorSample = 0;
  }

  var tempHtml = "<div id='sampleListName' onClick='setSampleConfigName()'>" + curSampleConfig.name + "</div><br>";

  for( var i = 0;i < curSampleConfig.groups.length;i++ )
  {
    var g = curSampleConfig.groups[ i ];
    var classes = 'css_groupClass';

    switch( g.seqType )
    {
      case "Single":  break;
      case "Next": classes += ' css_groupSeqNext'; break;
      case "Play": classes += ' css_groupSeqCont'; break;
    }

    if( i == curSampleConfig.groups.length - 1 )
      tempHtml += "<button id='clipboard' class='css_Clipboard' draggable='true' " +
                  "ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )'> Clipboard </button>\n";
    else
      tempHtml += "<button id='slGroup." + i + "' class='" + classes + "' onclick='groupClick( " + i + " )' draggable='true' " +
                  "ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )'>" + g.name + "</button>\n";

    for( var j = 0;j < g.samples.length;j++ )
      tempHtml += "<button id='slSample." + i + "." + j + "' class='css_slSample' onclick='sampleClick( " + i + ", " + j + " )'" +
                  " draggable='true' ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )''>" +
                  g.samples[ j ].displayName + "</button>\n";

    tempHtml += "<button id='slSample." + i + "." + j + "' class='css_slSample' onclick='sampleClick( " + i + ", " + j + " )'" +
                "  ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )'>&nbsp+&nbsp</button>\n";

    if( g.samples.length )
      tempHtml += "<font size='1'>" + g.samples.length + "</font>";
    tempHtml += "<br>\n";
  }

  tempHtml += "<br><button onclick='groupAdd()'> Add Group </button>\n<br>\n<br>";
  tempHtml += "<input id='trashCan' type='image' ondragover='sl_allowDrop( event )' ondrop='dropElem( event )' src='https://greggirardin.github.io/trashcan.png'/>\n";

  document.getElementById( 'setlist' ).innerHTML = tempHtml;

  if( slEditedFlag )
    document.getElementById( 'saveConfigButton' ).classList.add( 'css_highlight_red' );
  else
    document.getElementById( 'saveConfigButton' ).classList.remove( 'css_highlight_red' );

  var elem;
  if( cursorGroup >= 0 && cursorSample >= 0 )
    elem = document.getElementById( 'slSample.' + cursorGroup + '.' + cursorSample );
  else if( cursorGroup )
    elem = document.getElementById( 'slGroup.' + cursorGroup );
  if( elem )
    elem.classList.add( 'css_cursor' );

  if( curAF )
    document.getElementById( curAF.sampleObj.id ).classList.add( 'css_playing' );

  //if( !audioFiles[ curSampleConfig.groups[ i ].samples[ j ].filename ] )
  //  classes += ' css_pending';
}

function saveEdits()
{
  if( editSample )
  {
    editSample.displayName = document.getElementById( "editSampleName" ).value; 
    editSample.volume = document.getElementById( "editSampleVolume" ).value; 
    editSample.fadeInTime = document.getElementById( "editSampleFIT" ).value; 
    editSample.fadeOutTime = document.getElementById( "editSampleFOT" ).value; 
    editSample.loopType = document.getElementById( "editSamplePT" ).value; 
  }

  if( editGroup )
  {
    editGroup.name = document.getElementById( "editGroupName" ).value;
    editGroup.seqType = document.getElementById( "editGroupSequence" ).value;
  }

  slEditedFlag = true;
}

///////////////////////// ///////////////////////// /////////////////////////
function changeMode( mode )
{
  // We were editing a library file. Save the changes.
  if( operationMode == "Mode_Edit" )
  {
    saveEdits();
    document.getElementById( 'multiuse' ).innerHTML = "";
  }

  editSample = undefined;
  editGroup = undefined;
  operationMode = ( mode == operationMode ) ? "Mode_Default" : mode;

  var buttons = document.getElementsByClassName( 'css_modeButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'css_highlight_red' );
  buttons = document.getElementsByClassName( 'css_menuButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'css_highlight_red' );

  if( operationMode != "Mode_Default" )
  {
    var elem;
    switch( operationMode )
    {
      case "Mode_Default":    elem = document.getElementById( 'modeMedleyButton' );     break;
      case "Mode_Highlight":  elem = document.getElementById( 'modeHighlightButton' );  break;
      case "Mode_Edit":       elem = document.getElementById( 'modeEditButton' );       break;
    }
    elem.classList.add( 'css_highlight_red' );
  }

  genSampleConfigHTML();
  generateLibraryHTML();
}

/////////////// /////////////// /////////////// ///////////////
// generate the library pane.
// 1) list of samples from the library that can be dragged into the set list 
// 2) A library song we're editing.
/////////////// /////////////// /////////////// ///////////////
function generateLibraryHTML()
{
  var tmpHtml = "";
  var t = []; // Array for sorting.

  for( const[ key, value ] of Object.entries( sampleLibrary ) )
    t.push( value );
  t.sort( function( a, b ){ return ( a.filename > b.filename ) ? 1 : -1 } );

  if( !t.length )
    tmpHtml += "<h2>No Sample Library.</h2>";
  else
    for( var i = 0;i < t.length;i++ )
      tmpHtml += "<button id='libSample." + t[ i ].filename +
                 "' class='css_librarySample' draggable='true' ondragstart='dragElem( event )'" + 
                  "onclick='libSampleClick( \"" + t[ i ].filename + "\")'>" + t[ i ].filename + "</button>\n";

  document.getElementById( 'libraryDiv' ).innerHTML = tmpHtml;
}

/////////////// /////////////// /////////////// ///////////////
// This are just a couple big string literals for the generated output setlist html.
// Put here to make the export function more readable
/////////////// /////////////// /////////////// ///////////////
function htmlConstStrings( index )
{
  switch( index )
  {
  case 0:
    return( function(){/* 
<h2> Sample Player Creator </h2>
Create a new Sample List with 'New'. Add Groups with 'Add Group'. Click on names to rename.<br>
<br>
Drag samples from the Library in the right pane to the desired location. Samples and groups can be rearranged
by dragging. Delete things by dragging to the Trash.<br>
<br>
A library can be specified by appending "?library=http://x.y.z/???.json" to this URL.
    
*/}.toString().slice( 14, -3 ) + "</" + "script> </" + "body> </html>" ); // little hack because certain tags confuse the browser.
  break;
  }

  return undefined;
}

////////////////////// //////////////////////
// Sample List file mgmt
////////////////////// //////////////////////
function openSampleFile( e )
{
  var file = e.target.files[ 0 ];
  if( !file )
    return;
  var reader = new FileReader();
  reader.onload = function( e )
  {
    var lines = e.target.result.split( "\n" ); // Line 2->n is JSON of the setList
    var jsonPortion = ""; // setlist json beings with { in column 0 and ends with } in column 0.
    var firstLine = true;
    var success = false;

    for( line of lines )
    {
      if( firstLine )
      {
        firstLine = false; // first line is opening comment
        continue;
      }

      jsonPortion += line;
      if( line == "}" )
      {
        success = true; // found the end of json.
        break;
      }
    }
    if( success )
    {
      try
      {
        var parsed = JSON.parse( jsonPortion );
        curSampleConfig = parsed;
      }
      catch( error )
      {
        alert( error );
      }
    }
    else
      alert( "Unable to parse setlist" );

    genSampleConfigHTML();
  }

  reader.readAsText( file );
}

/////////////// /////////////// /////////////// /////////////// ///////////////
// Generate the config
/////////////// /////////////// /////////////// /////////////// ///////////////
function saveSampleConfig()
{
  saveEdits();

  var configData = JSON.stringify( curSampleConfig, null, "  " );

  var formData = new FormData();
  formData.append( "data", configData );

  var xhr = new XMLHttpRequest();
  xhr.open( 'post', serverURL + configFile );
  xhr.send( formData );

  slEditedFlag = false;
  genSampleConfigHTML();
  return true;
}

var helpState = false;
function toggleHelp()
{
  helpState = !helpState;
  var helpHtml = "";

  if( helpState )
    helpHtml = htmlConstStrings( 0 );

  var helpElem = document.getElementById( 'multiuse' );
  helpElem.innerHTML = helpHtml;
}

</script>
</body>
</html>