<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sample Player</title>
<style>

.css_librarySample
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_librarySample:hover { border: 2px solid black; }

.css_sampleListSample
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_menuButton
{
  border: 2px solid white;
  background-color: #ddf;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_menuButton:hover { border: 2px solid black; }

.css_modeButton
{
  border: 2px solid white;
  background-color: #bbf;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.css_modeButton:hover { border: 2px solid black; }

.css_FSButton
{
  border: 2px solid white;
  background-color: #bbf;
  color: #444;
  padding: 6px;
  text-align: denter;
  font-size: 14px;
}

.css_FSButton:hover { border: 2px solid black; }

.css_groupClass
{
  border: 2px solid white;
  background-color: #ccf;
  color: #000;
  padding: 2px;
  text-align: center;
  font-size: 16px;
}

.css_Clipboard
{
  border: 1px solid black;
  background-color: #fff;
  color: #000;
  padding: 2px;
  text-align: center;
  font-size: 16px;
}

#sampleListName { font-size: 20px; }

.css_medleyStart
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 80% 0, 100% 50%, 80% 100%, 0% 100%, 5% 50% );
}

.css_medleyCont
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0 15%, 95% 15%, 95% 85%, 0% 85% );
}

.css_medleyEnd
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 90% 0%, 80% 50%, 90% 100%, 0% 100% );
}

.css_s_highlight { color: #f00; }
.css_highlight_red { background-color: #f00; }
.css_highlight_pink { background-color: #faa; }

.css_topButtons
{
  background-color: #fdd;
  padding: 10px;
  font-size: 16px;
}

.css_sampleList_pane
{
  align-items: left;
  margin: 0;
  padding: 0;
  width: 49.5%;
  background-color: #f1f1f1;
  height: 50%;
  overflow: auto;
  border: 1px solid black;
  float: left
}

.css_library_pane
{
  align-items: left;
  margin: 0;
  padding: 0;
  width: 49.5%;
  background-color: #f1f1f1;
  border: 1px solid black;
  float: right
}

.css_library
{
  overflow: scroll;
  height: 90vh;
}

.css_editSample
{
  padding: 10px;
  font-size: 14px;
  text-align: left;
  background-color: #ddf;
  border: 1px solid black;
  font-family: "Lucida Console", "Courier New", monospace;
}

.slider
{
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover
{
  opacity: 0;
}

.slider::-webkit-slider-thumb
{
  -webkit-appearance: none;
  appearance: none;
  width: 25px;
  height: 25px;
  background: #04AA6D;
  cursor: pointer;
}

.slider::-moz-range-thumb
{
  width: 25px;
  height: 25px;
  background: #04AA6D;
  cursor: pointer;
}

#trashCan
{
  display: block;
  height: 40px;  
  width: 30px;
}

</style>
</head>
<body align="left">
<section>
<div id='samplesPane' class='css_sampleList_pane'>
<input contenteditable='true' id='serverURL' value='URL'>
<button class='css_menuButton' id='saveConfigButton'    onclick='saveSampleConfig();'>Save</button>
<button class='css_modeButton' id='modeEditButton'      onclick='changeMode( "Mode_Edit" );'>Edit</button>
<button class='css_modeButton' id='modeHighlightButton' onclick='changeMode( "Mode_Highlight" );'>Highlight</button>
<button class='css_modeButton' id='clipboard'           onclick='changeMode( "Mode_Clipboard" );'>Clipboard</button>
<button class='css_modeButton' id='Help'                onclick='toggleHelp();'>Help</button>
<hr>
<div id='footSwitchButtons' align='left'>
Tap
<button class='css_FSButton' id='fsB1Tap' onclick='buttonEvent( "EVENT_TAP", "BUTTON1" );'>&larr;</button>
<button class='css_FSButton' id='fsB2Tap' onclick='buttonEvent( "EVENT_TAP", "BUTTON2" );'>&rarr;</button>
<button class='css_FSButton' id='fsBBTap' onclick='buttonEvent( "EVENT_TAP", "BUTTONB" );'>Both</button>
Hold
<button class='css_FSButton' id='fsB1Hold' onclick='buttonEvent( "EVENT_HOLD", "BUTTON1" );'>&uarr;</button>
<button class='css_FSButton' id='fsB2Hold' onclick='buttonEvent( "EVENT_HOLD", "BUTTON2" );'>&darr;</button>
<button class='css_FSButton' id='fsBBHold' onclick='buttonEvent( "EVENT_HOLD", "BUTTONB" );'>Both</button>
Double Tap
<button class='css_FSButton' id='fsB1DTap' onclick='buttonEvent( "EVENT_DTAP", "BUTTON1" );'>&#62;</button>
<button class='css_FSButton' id='fsB2DTap' onclick='buttonEvent( "EVENT_DTAP", "BUTTON2" );'>&#8800;</button>
<hr>
</div>
<div id='setlist'> </div>
<div id='multiuse'></div>
</div><form action="" method="get"></form>

<div id='library_pane' class='css_library_pane'>
<hr>
<div id='libraryDiv' class='css_library'> </div>
</div>
</section>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>

var serverURL = 'http://192.168.0.2:8080/'; // this is where samples.json and all the samples live.
var configFile = 'sampleConfig.json';
//var serverURL = 'https://greggirardin.github.io/samples/';
// Can specify in URL. https://setlist.loc.com/?serverURL='https://your.samples.loc/path/to/stuff'
var slEditedFlag = false;
var sampleLibrary = {}; // object of ClLibrarySample
var curSampleConfig;
var editSample; // Sample we're editing if "Mode_Edit"

// Constants.
const MAX_GROUPS = 10;

var operationMode = "Mode_Default";
var fsMode = "PM"; 
var currentGroup = 0, currentSample = 0; // cursor

//////////////////////////// //////////////////////////// ////////////////////////////
class CLibrarySample
{
  constructor( filename )
  {
    this.filename = filename;
    // length?
    // last change time?
  }
}

class CSample
{
  constructor( displayName, filename=undefined )
  {
    this.displayName = displayName;
    this.filename = filename; // filename on the server.
    this.highlight = false;
    this.medley = false;
    this.fadeInTime = 0; // Milliseconds
    this.fadeOutTime = 0;
    this.loopCount = 1;
    this.volume = 100;
  }
}

class CGroup
{
  constructor( name )
  {
    if( !name )
      name = "Group";
    this.name = name;
    this.samples = []; // Sample[]
  }
}

class CSampleConfig
{
  constructor( sampListName )
  {
    this.name = sampListName;
    this.sampleBaseURL = undefined; // The prefix of the path to all the samples
    this.groups = [];
    this.groups.push( new CGroup() );
    this.groups.push( new CGroup( "Clipboard" ) );
  }
}

//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////
window.onload = sampleListInit;

function changeURL()
{
  serverURL = document.getElementById( 'serverURL' ).value;
  console.log( "URL=" + serverURL );
}

/////////////// /////////////// /////////////// ///////////////
function sampleListInit()
{
  const urlParams = new URLSearchParams( window.location.search );
  var server = urlParams.get( 'serverURL' );
  if( server ) // Server URL provided by user
    serverURL = server;

  newSampleConfig();
  getFileFromServer( "samples.json", gotSamples, false );
  getFileFromServer( configFile, gotConfig, false );

  document.getElementById( 'serverURL' ).value = serverURL;
  document.getElementById( 'serverURL' ).addEventListener( 'change', changeURL, false );

  document.addEventListener( 'keydown', keyPressedHandler );
  document.addEventListener( 'keyup', keyRelHandler );

  footSwitchButtons[ 0 ] = new FootSwitchButton( "BUTTON1" );
  footSwitchButtons[ 1 ] = new FootSwitchButton( "BUTTON2" );
}

///////////////////////// ///////////////////////// /////////////////////////
///////////////////////// ///////////////////////// /////////////////////////
/* Foot switch handling for two buttons. Assume the buttons are mapped to UP and DOWN.
   8 functions: Tap L+R, Double Tap L+R, Hold L+R, Both Tap, Both hold

          | Start Timer       clickHoldTO
  Time -----------------------|
    ______/-------------------| Hold
    ______/----------\________| Single Tap
    ______/--\___/-| Double Tap 
          ^--- Button pressed
*/
const clickHoldTO = 250;

var footSwitchButtons = []; // array of buttons
var bothHeldTimer;

var fsMode = "PM"; // Play Mode

var fsButtonMap = 
{
  "EVENT_TAP" :
  {
    "BUTTON1" :
    {
      id : 'fsB1Tap', // the DOM element to flash
      PM :
      { // Play Mode
        html : "&larr;",
        action : function() { moveCursor( 'LEFT' ); }
      },
      DM :
      { // Direct Mode
        html : "",
        action : function() { }
      }
    },
    "BUTTON2" :
    {
      id : 'fsB2Tap',
      PM :
      {
        html : "&rarr;",
        action : function() { moveCursor( 'RIGHT' ); }
      },
      DM :
      {
        html : "",
        action : function() { }
      }
    },
    "BUTTONB" :
    { 
      id : 'fsBBTap',
      PM : 
      {
        html : "NA",
        action : function() { }
      },
      DM :
      {
        html : "NA",
        action : function() { }
      } 
    },
  },

  "EVENT_DTAP" :
  {
    "BUTTON1" :
    {
      id : 'fsB1DTap',
      PM : 
      {
        html : "&#62;",
        action : function() { playSample( 'START' ); }
      },
      DM :
      {
        html : "&#62;",
        action : function() { playSample( 'START' ); }
      }
    },
    "BUTTON2" :
    {
      id : 'fsB2DTap',
      PM :
      {
        html : "#8800;",
        action : function() { playSample( 'STOP' ) }
      },
      DM :
      {
        html : "#8800;",
        action : function() { playSample( 'STOP' ) }
      }
    },
  },

  "EVENT_HOLD" :
  {
    "BUTTON1" :
    {
      id : 'fsB1Hold',
      PM : 
      {
        html : "&uarr;",
        action : function() { moveCursor( 'UP' ); }
      }, 
      DM :
      {
        html : "#8800;",
        action  : function() { moveCursor( 'UP' ); }
      }
    },
    "BUTTON2" :
    {
      id : 'fsB2Hold',
      PM : 
      {
        html : "&darr;",
        action : function() { moveCursor( 'DOWN' ); }
      },
      DM : 
      {
        html : "#8800;",
        action : function() { moveCursor( 'DOWN' ); }
      }
    },
    "BUTTONB" :
    {
      id : 'fsBBHold',
      PM : 
      {
        html : "Play",
        action : function() { togglePlayMode(); }
      },
      DM : 
      {
        html : "Direct",
        action : function() { togglePlayMode(); }
      }
    },
  }
};

function togglePlayMode()
{
  var elem = document.getElementById( 'fsBBHold' );

  if( fsMode == "PM" )
  {
    fsMode = "DM"; // direct mode
    elem.innerHTML = "Direct";
  }
  else
  {
    fsMode = "PM"; // play mode
    elem.innerHTML = "Play";
  }

}

function playSample( status )
{
  console.log( "play:" + status );
}

function moveCursor( dir )
{
  switch( dir )
  {
    case 'UP':
      if( currentGroup > 0 )
        currentGroup -= 1;
      break;

    case 'DOWN':
      if( currentGroup < curSampleConfig.groups.length - 2 )
        currentGroup += 1;
      break;

    case 'LEFT':
      if( currentSample > 0 )
        currentSample -= 1;
      break;

    case 'RIGHT':
      if( currentSample < curSampleConfig.groups[ currentGroup ].samples.length - 1 )
        currentSample += 1;
      break;
  }

  var l = curSampleConfig.groups[ currentGroup ].samples.length;
  if( currentSample >= l - 1 )
    currentSample = l > 0 ? l - 1 : 0;

  genSampleConfigHTML();
}

function buttonEvent( event, buttonID )
{
  fsButtonMap[ event ][ buttonID ][ fsMode ].action();

  var elem = document.getElementById( fsButtonMap[ event ][ buttonID ].id );
  elem.classList.add( 'css_highlight_red' );
  setTimeout( buttonHLTimer, 100 );
}

function buttonHLTimer()
{
   var buttons = document.getElementsByClassName( 'css_FSButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'css_highlight_red' );
}

function bothHoldTimerCB()
{
  // Both buttons were held.
  bothHeldTimer = undefined; // clear. It's used as a flag below.
  buttonEvent( "EVENT_HOLD", "BUTTONB" );
  footSwitchButtons[ 0 ].pressedState = false;
  footSwitchButtons[ 1 ].pressedState = false;
}

class FootSwitchButton
{
  constructor( identifier )
  {
    this.buttonID = identifier;
    this.buttonState = false;
    this.holdFlag = false;
    this.pressedState = false;
    this.holdTimer = undefined;
  }

  clearTimer()
  {
    clearTimeout( this.holdTimer );
    this.holdTimer = undefined;
  }

  setState( newState )
  {
    if( newState != this.buttonState )
    {
      this.buttonState = newState;

      if( newState ) // true = 'down'
      {
        // Check for both buttons pressed
        var otherButtonIx = ( this.buttonID == "BUTTON1" ) ? 1 : 0;
        if( footSwitchButtons[ otherButtonIx ].buttonState ) // both pressed ?
        {
          this.clearTimer(); // clear existing timers and set the 'both' timer.
          footSwitchButtons[ otherButtonIx ].clearTimer();
          bothHeldTimer = setTimeout( bothHoldTimerCB, clickHoldTO );
        }
        else
        {
          if( !this.pressedState ) 
          { // first click
            this.holdFlag = true;
            this.pressedState = true; 
            this.holdTimer = setTimeout( holdTimerCB, clickHoldTO, this.buttonID );
          }
          else 
          { // this is the second click.

            this.clearTimer();
            this.pressedState = false;
            buttonEvent( "EVENT_DTAP", this.buttonID );
          }
        }
      }
      else // up
      {
        this.holdFlag = false;

        if( bothHeldTimer ) // both aren't pressed but they were previously
        {
          var otherButtonIx = ( this.buttonID == "BUTTON1" ) ? 1 : 0;
          clearTimeout( bothHeldTimer );
          bothHeldTimer = undefined;
          this.clearTimer();
          this.pressedState = false; 

          footSwitchButtons[ otherButtonIx ].clearTimer();
          footSwitchButtons[ otherButtonIx ].pressedState = false;
          buttonEvent( "EVENT_TAP", "BUTTONB" );
        }
      }
    }
  }

  holdTimerCB()
  {
    this.pressedState = false;
    this.holdTimer = undefined;
    buttonEvent( this.holdFlag ? "EVENT_HOLD" : "EVENT_TAP", this.buttonID );
  }
}

// TBD. Call class method directly?
function holdTimerCB( ButtonID )
{
  footSwitchButtons[ ( ButtonID == "BUTTON1" ) ? 0 : 1 ].holdTimerCB();
}

function keyPressedHandler( e ) // down / pressed
{
  var ix;

  switch( e.code )
  {
    case 'ArrowLeft':
    case 'ArrowUp':   ix = 0; break;
    case 'ArrowRight':
    case 'ArrowDown': ix = 1; break;
    default: return;
  }
  footSwitchButtons[ ix ].setState( true );
}

function keyRelHandler( e ) // up / released
{
  var ix;

  switch( e.code )
  {
    case 'ArrowLeft':
    case 'ArrowUp':   ix = 0; break;
    case 'ArrowRight':
    case 'ArrowDown': ix = 1; break;
    default: return;
  }
  footSwitchButtons[ ix ].setState( false );
}

///////////////////////// ///////////////////////// /////////////////////////
///////////////////////// ///////////////////////// /////////////////////////
function gotSamples( file, data )
{
  sampleLibrary = JSON.parse( data );

  generateLibraryHTML();
}

function gotConfig( file, data )
{
  curSampleConfig = JSON.parse( data );

   for( g = 0;g < curSampleConfig.groups.length;g++ )
    for( s = 0;s < curSampleConfig.groups[ g ].samples.length;s++ ) 
      getFileFromServer( curSampleConfig.groups[ g ].samples[ s ].filename, gotSample, false );

    genSampleConfigHTML();
}

function gotSample( filename, data )
{
  console.log( "Got " + filename + " data." );
  // find all samples that want this sample audio.
  for( g = 0;g < curSampleConfig.groups.length;g++ )
    for( s = 0;s < curSampleConfig.groups[ g ].samples.length;s++ ) 
      if( curSampleConfig.groups[ g ].samples[ s ].filename == filename )
        curSampleConfig.groups[ g ].samples[ s ].audioFile = data;
}

function getFileFromServer( fileName, callback, binaryFlag )
{
  var xhr = new XMLHttpRequest();

  if( binaryFlag )
  {
    var fullURL = 'blob:' + serverURL + filename;
    xhr.open( 'GET', fullURL, true );
    xhr.responseType = 'blob';
    xhr.onload = function( e )
    {
      if( this.status == 200 )
        callback( fileName, this.response );
    }
  }
  else
  {
    xhr.overrideMimeType( "application/json" );
    xhr.open( "GET", serverURL + fileName, true );
    xhr.onreadystatechange = function()
    {
      if ( xhr.readyState === 4 && xhr.status == "200" )
        callback( fileName, xhr.responseText );
    }
  }

  xhr.send( null );
}

function sl_allowDrop( ev ) { ev.preventDefault(); }
function dragElem( ev ) { ev.dataTransfer.setData( "dragElem", ev.target.id ); }

/////////////// /////////////// /////////////// ///////////////
// Handle a song being dropped onto a setlist file.
// Samples can be dragged from within the setlist to move them or from the Library to add them.
/////////////// /////////////// /////////////// ///////////////
function dropElem( ev )
{
  const slSample = "sampleListSample.";
  const slGroup = "sampleListGroup.";
  const cbStr = "clipboard";
  const lSamp = "libSample.";

  ev.preventDefault();
  var dragElem = ev.dataTransfer.getData( "dragElem" );

  if( ( dragElem.substring( 0, cbStr.length ) == cbStr ) &&
      ( ev.target.id.substring( 0, slSample.length ) == slSample ) ) // dropping the clipboard onto a set.
  {
    indexes = ev.target.id.substring( slSample.length, ).split( "." );
    var toGroup = parseInt( indexes[ 0 ] );
    var toSampleIx = parseInt( indexes[ 1 ] );

    if( toGroup < curSampleConfig.groups.length - 1 )
      while( true )
      {
        var song = curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples.pop();
        if( song )
          curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, song );
        else
          break;
      }
  }
  else if( ( dragElem.substring( 0, slSample.length ) == slSample ) &&
           ( ev.target.id.substring( 0, slSample.length ) == slSample ) ) // Moving a sample
  {
    var indexes = dragElem.substring( slSample.length, ).split( "." );
    var fromGroup = parseInt( indexes[ 0 ] );
    var fromSampleIx = parseInt( indexes[ 1 ] );

    indexes = ev.target.id.substring( slSample.length, ).split( "." );
    var toGroup = parseInt( indexes[ 0 ] );
    var toSampleIx = parseInt( indexes[ 1 ] );

    if( fromGroup == toGroup ) // Moving within the same set
    {
      if( toSampleIx < fromSampleIx ) // Moved song up
      {
        curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, curSampleConfig.groups[ fromGroup ].samples[ fromSampleIx ] );
        curSampleConfig.groups[ fromGroup ].samples.splice( fromSampleIx + 1, 1 );
      }
      else
      {
        curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx + 1, 0, curSampleConfig.groups[ fromGroup ].samples[ fromSampleIx ] );
        curSampleConfig.groups[ fromGroup ].samples.splice( fromSampleIx, 1 );
      }
    }
    else // Move between groups.
    {
      curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, curSampleConfig.groups[ fromGroup ].samples[ fromSampleIx ] );
      curSampleConfig.groups[ fromGroup ].samples.splice( fromSampleIx, 1 );
    }

    slEditedFlag = true;
  }
  else if( ( dragElem.substring( 0, lSamp.length ) == lSamp ) &&
           ( ev.target.id.substring( 0, slSample.length ) == slSample ) ) // Dropping library song into set list.
  {
    var sampId = dragElem.substring( lSamp.length, );
    var libSample = sampleLibrary[ sampId ];

    var newSample = new CSample( sampId, libSample.filename );

    var indexes = ev.target.id.substring( slSample.length, ).split( "." );
    var toGroup = parseInt( indexes[ 0 ] );
    var toSampleIx = parseInt( indexes[ 1 ] );

    curSampleConfig.groups[ toGroup ].samples.splice( toSampleIx, 0, newSample );

    slEditedFlag = true;
  }
  else if( ( dragElem.substring( 0, slGroup.length ) == slGroup ) &&
           ( ev.target.id.substring( 0, slGroup.length ) == slGroup ) ) // Moving a group
  {
    var fromGroup = parseInt( dragElem.substring( slGroup.length, ) );
    var toGroup = parseInt( ev.target.id.substring( slGroup.length, ) );

    if( toGroup < fromGroup ) // moved group up
    {
      curSampleConfig.groups.splice( toGroup, 0, curSampleConfig.groups[ fromGroup ] );
      curSampleConfig.groups.splice( fromGroup + 1, 1 );
    }
    else
    {
      curSampleConfig.groups.splice( toGroup + 1, 0, curSampleConfig.groups[ fromGroup ] );
      curSampleConfig.groups.splice( fromGroup, 1 );
    }

    slEditedFlag = true;
  }
  else if( ev.target.id == "trashCan" )
  {
    if( dragElem.substring( 0, slSample.length ) == slSample )
    {
      var indexes = dragElem.substring( slSample.length, ).split( "." );
      var delGroup = parseInt( indexes[ 0 ] );
      var delSample = parseInt( indexes[ 1 ] );

      curSampleConfig.groups[ delGroup ].samples.splice( delSample, 1 );
    }
    else if( dragElem.substring( 0, slGroup.length ) == slGroup )
    {
      var delGroup = parseInt( dragElem.substring( slGroup.length, ) );
      curSampleConfig.groups.splice( delGroup, 1 );
    }
    else if( dragElem.substring( 0, cbStr.length ) == cbStr )
      curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples = [];

    slEditedFlag = true;
  }

  genSampleConfigHTML();
}

/////////////// /////////////// /////////////// ///////////////
function setSampleConfigName()
{
  var name = prompt( "Enter Sample File Name:", curSampleConfig.name );
  if( name )
  {
    curSampleConfig.name = name;
    slEditedFlag = true;
    genSampleConfigHTML();
  }
}

/////////////// /////////////// /////////////// ///////////////
function sampleClick( groupIndex, sampleIndex )
{
  var cs = curSampleConfig.groups[ groupIndex ].samples[ sampleIndex ]; // clicked song.

  currentGroup = groupIndex;
  currentSample = sampleIndex;

  if( operationMode == "Mode_Highlight" )
    cs.highlight = !cs.highlight;
  else if( operationMode == "Mode_Default" )
    cs.medley = !cs.medley;
  else if( ( operationMode == "Mode_Clipboard" ) && ( groupIndex < curSampleConfig.groups.length - 1 ) )
  {
    var sample = curSampleConfig.groups[ groupIndex ].samples[ sampleIndex ];
    curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples.push( sample );
    curSampleConfig.groups[ groupIndex ].samples.splice( sampleIndex, 1 );
   }
  else if( operationMode == "Mode_Edit" )
    editSample = cs;

  genSampleConfigHTML(); 
}

/////////////// /////////////// /////////////// ///////////////
// Handle actions when a song in the library is clicked.
// Library samples can be edited or deleted.
/////////////// /////////////// /////////////// ///////////////
function libSampleClick( songId )
{
  if( operationMode == "Mode_Clipboard" )
  {
    sample = new CSample( sampleLibrary[ songId ].filename );
    curSampleConfig.groups[ curSampleConfig.groups.length - 1 ].samples.push( sample );
    genSampleConfigHTML();
  }
}

/////////////// /////////////// /////////////// ///////////////
function newSampleConfig()
{
  if( slEditedFlag )
    if( !window.confirm( "Unsaved Edits. Continue?" ) )
      return;

  slEditedFlag = false;
  curSampleConfig = new CSampleConfig( "Sample List" );

  genSampleConfigHTML();
}

/////////////// /////////////// /////////////// ///////////////
function groupRename( groupIndex )
{
  var name = prompt( "Enter Group Name:", curSampleConfig.groups[ groupIndex ].name );

  if( name )
  {
    curSampleConfig.groups[ groupIndex ].name = name;
    var elem = document.getElementById( "sampleListGroup." + groupIndex );
    elem.innerHTML = name;
  }

  slEditedFlag = false;
  genSampleConfigHTML();
}

/////////////// /////////////// /////////////// ///////////////
function groupAdd()
{
  if( curSampleConfig.groups.length < MAX_GROUPS )
  {
    curSampleConfig.groups.splice( curSampleConfig.groups.length - 1, 0, new CGroup() );
    slEditedFlag = true;
    genSampleConfigHTML();
  }
  else
    alert( "Max set count reached" );
}

/////////////// /////////////// /////////////// ///////////////
function genSampleConfigHTML()
{
  if( operationMode == "Mode_Edit" && editSample )
  {
    var tmpHtml = "<hr>";
    tmpHtml += "Display Name: <input contenteditable='true' id='editSampleName' value='" + editSample.displayName + "'><br>";
    tmpHtml += "File: " + editSample.filename + "<br>";
    tmpHtml += "Volume: <input type='range' id='editSampleVolume' min='0' max='100' value='" + editSample.volume + "'><br>";
    tmpHtml += "Fade In: <input type='range' id='editSampleFIT' min='0' max='5000' value='" + editSample.fadeInTime + "'><br>";
    tmpHtml += "Fade Out: <input type='range' id='editSampleFOT' min='0' max='5000' value='" + editSample.fadeOutTime + "'><br>";
    tmpHtml += "Loop Count: <input contenteditable='true' id='editSampleLC' value='" + editSample.loopCount + "'><br>";

    var elem = document.getElementById( 'multiuse' ); // edit in the multiuse panel on the left
    elem.innerHTML = tmpHtml;
  }

  var tempHtml = "<div id='sampleListName' onClick='setSampleConfigName()'>" + curSampleConfig.name + "</div><br>";

  for( var i = 0;i < curSampleConfig.groups.length;i++ )
  {
    var s = curSampleConfig.groups[ i ];
    if( i == curSampleConfig.groups.length - 1 )
      tempHtml += "<button id='clipboard' class='css_Clipboard' draggable='true' " +
                  "ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )'> Clipboard </button>\n";
    else
      tempHtml += "<button id='sampleListGroup." + i + "' class='css_groupClass' onclick='groupRename( " + i + " )' draggable='true' " +
                  "ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )'>" + s.name + "</button>\n";

    var medleyState = false;

    for( var j = 0;j < s.samples.length;j++ )
    {
      var classes = 'css_sampleListSample';
      if( s.samples[ j ].highlight )
        classes += ' css_s_highlight';
      if( s.samples[ j ].medley && medleyState == false )
        classes += ' css_medleyStart';
      else if( s.samples[ j ].medley && medleyState == true ) 
        classes += ' css_medleyCont'; 
      else if( !s.samples[ j ].medley && medleyState == true ) 
        classes += ' css_medleyEnd';
      medleyState = s.samples[ j ].medley;

      tempHtml += "<button id='sampleListSample." + i + "." + j + "' class='" + classes + "' onclick='sampleClick( " + i + ", " + j + " )'" +
                  " draggable='true' ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )''>" +
                  s.samples[ j ].displayName + "</button>\n";
    }

    var tmpStr = ( curSampleConfig.groups[ i ].samples.length == 0 ) ? 'Add Samples Here' : '&nbsp+&nbsp';
    tempHtml += "<button id='sampleListSample." + i + "." + j + "' class='css_sampleListSample' onclick='sampleClick( " + i + ", " + j + " )'" +
                "  ondrop='dropElem( event )' ondragover='sl_allowDrop( event )' ondragstart='dragElem( event )'>" + tmpStr + "</button>\n";


    if( s.samples.length )
      tempHtml += "<font size='1'>" + s.samples.length + "</font>";
    tempHtml += "<br>\n";
  }

  tempHtml += "<br><button onclick='groupAdd()'> Add Group </button>\n<br>\n<br>";
  tempHtml += "<input id='trashCan' type='image' ondragover='sl_allowDrop( event )' ondrop='dropElem( event )' src='https://greggirardin.github.io/trashcan.png'/>\n";

  document.getElementById( 'setlist' ).innerHTML = tempHtml;

  if( slEditedFlag )
    document.getElementById( 'saveConfigButton' ).classList.add( 'css_highlight_red' );
  else
    document.getElementById( 'saveConfigButton' ).classList.remove( 'css_highlight_red' );

  if( currentGroup != undefined && currentSample != undefined )
  {
    var estr = 'sampleListSample.' + currentGroup + '.' + currentSample;
    document.getElementById( estr ).classList.add( 'css_highlight_pink' );
  }
}

function saveSampleEdits()
{
  if( editSample )
  {
    editSample.displayName = document.getElementById( "editSampleName" ).value; 
    editSample.volume = document.getElementById( "editSampleVolume" ).value; 
    editSample.fadeInTime = document.getElementById( "editSampleFIT" ).value; 
    editSample.fadeOutTime = document.getElementById( "editSampleFOT" ).value; 
    editSample.loopCount = document.getElementById( "editSampleLC" ).value; 
  }
}

///////////////////////// ///////////////////////// /////////////////////////
function changeMode( mode )
{
  // We were editing a library file. Save the changes.
  if( operationMode == "Mode_Edit" && editSample )
  {
    saveSampleEdits();
    document.getElementById( 'multiuse' ).innerHTML = "";
  }

  editSample = undefined;
  operationMode = ( mode == operationMode ) ? "Mode_Default" : mode;

  var buttons = document.getElementsByClassName( 'css_modeButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'css_highlight_red' );
  buttons = document.getElementsByClassName( 'css_menuButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'css_highlight_red' );

  if( operationMode != "Mode_Default" )
  {
    var elem;
    switch( operationMode )
    {
      case "Mode_Default":    elem = document.getElementById( 'modeMedleyButton' );     break;
      case "Mode_Highlight":  elem = document.getElementById( 'modeHighlightButton' );  break;
      case "Mode_Edit":       elem = document.getElementById( 'modeEditButton' );       break;
      case "Mode_Clipboard":  elem = document.getElementById( 'clipboard' );            break;
    }
    elem.classList.add( 'css_highlight_red' );
  }

  genSampleConfigHTML();
  generateLibraryHTML();
}

function pruneQuote( convString )
{
  var newString = "";

  for( var i = 0;i < convString.length;i++ )
    if( convString[ i ] != "'" )
      newString += convString[ i ];

  return newString;
}

/////////////// /////////////// /////////////// ///////////////
// generate the library pane.
// 1) list of samples from the library that can be dragged into the set list 
// or
// 2) A library song we're editing.
/////////////// /////////////// /////////////// ///////////////
function generateLibraryHTML()
{
  // Show the library
  var tmpHtml = "";
  var t = []; // Array for sorting.

  for( const[ key, value ] of Object.entries( sampleLibrary ) )
  {
    t.push( value );
  }
  t.sort( function( a, b ){ return ( a.filename > b.filename ) ? 1 : -1 } );

  if( !t.length )
    tmpHtml += "<h2>No Sample Library.</h2>";
  else
    for( var i = 0;i < t.length;i++ )
    {
      tmpHtml += "<button id='libSample." + t[ i ].filename +
                 "' class='css_librarySample' draggable='true' ondragstart='dragElem( event )'" + 
                  "onclick='libSampleClick( \"" + t[ i ].filename + "\")'>" + 
                  t[ i ].filename + "</button>\n";
    }

  document.getElementById( 'libraryDiv' ).innerHTML = tmpHtml;
}

/////////////// /////////////// /////////////// ///////////////
// This are just a couple big string literals for the generated output setlist html.
// Put here to make the export function more readable
/////////////// /////////////// /////////////// ///////////////
function htmlConstStrings( index )
{
  switch( index )
  {
    case 0:
      return( function(){/* 
<style>
.accordion
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  cursor: pointer;
  padding: 6px;
  text-align: left;
  outline: none;
  font-size: 16px;
  transition: 0.2s;
}

.fixedFont
{
  font-family: monospace;
}

.panel
{
  padding: 0 18px;
  display: none;
  overflow: hidden;
  font-size: 20px;
  background-color: #fee;
  text-align: left;
}

.css_medleyStart
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 90% 0, 100% 50%, 90% 100%, 0% 100%, 5% 50% );
}

.css_medleyCont
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0 15%, 95% 15%, 95% 85%, 0% 85% );
}

.css_medleyEnd
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 95% 0%, 85% 50%, 95% 100%, 0% 100% );
}

.css_highlight
{
  color: #d33;
}

.css_topButtons
{
  background-color: #fdd;
  padding: 10px;
  font-size: 16px;
}

</style>
</head>

<body align="center">
<button class="css_topButtons" id="fontButtonFixed" onclick="fontFixed();">Fixed</button>
<button class="css_topButtons" id="fontButton+" onclick="fontPlus();">Font +</button>
<button class="css_topButtons" id="fontButton-" onclick="fontMinus();">Font -</button>
<button id="fontSizeButton">Size</button>
<button class="css_topButtons" id="verticalButton+" onclick="displayPlus();">Expand</button>
<button class="css_topButtons" id="verticalButton-" onclick="displayMinus();">Shrink</button>
<!--
<button class="css_topButtons" id="prevSongId" onclick="changeSong( -1 );">Prev</button>
<button class="css_topButtons" id="nextSongId" onclick="changeSong( 1 );">Next</button>
-->
*/}.toString().slice( 14, -3 ) ) ;
break;

  case 1:
    return( function(){/* 
<script>
const minFont = 14
const maxFont = 24;
var fontSize = 16;

var fixed = false;

function fontFixed()
{
  fixed = !fixed;

  var panels = document.getElementsByClassName( "panel" );

  for( var i = 0;i < panels.length;i++ )
    if( fixed )
      panels[ i ].classList.add( "fixedFont" );
    else
      panels[ i ].classList.remove( "fixedFont" );
}

function fontPlus()
{
  fontSize += 2;
  if( fontSize > maxFont )
    fontSize = maxFont;

  setFontProperty( fontSize );
}

function fontMinus()
{
  fontSize -= 2;
  if( fontSize < minFont )
    fontSize = minFont;

  setFontProperty( fontSize );
}

function setFontProperty()
{
  var fontSizeStr = fontSize.toString() + "px";
  var elem = document.getElementById( "fontSizeButton" );
  elem.style.fontSize = fontSizeStr;
  elem.innerHTML = fontSizeStr;

  for( var i = 0;i < acc.length;i++ )
    acc[ i ].nextElementSibling.style.fontSize = fontSizeStr;
}

var currentSongIx;

function changeSong( delta ) // open the song 'delta' ahead of the current.
{
  var newSongIx = currentSongIx + delta;
  if( newSongIx >= 0 && newSongIx <= acc.length )
    accordionClick( acc[ newSongIx ] );
}

const DISPLAY_MIN = 0;
const DISPLAY_MED1 = 1;
const DISPLAY_MED2 = 2;
const DISPLAY_LARGE = 3;

var displayFormat = DISPLAY_LARGE;

function displayPlus()
{
  if( displayFormat < DISPLAY_LARGE )
  {
    displayFormat++;
    displaySet( displayFormat );
  }
}

function displayMinus()
{
  if( displayFormat > DISPLAY_MIN )
  {
    displayFormat--;
    displaySet( displayFormat );
  }
}

function closeAll()
{
  // Close all accordions
  for( var i = 0;i < acc.length;i++ )
  {
    acc[ i ].nextElementSibling.style.display = "none"; 
    acc[ i ].classList.remove( "active" );
  }
}

function displaySet( disFormat )
{
  var minWProp;
  var fSize = "16px"; // Font size of song names in accordions
  var slFontSize; // set list font size

  closeAll();

  var clipPath;

  switch( disFormat )
  {
    case DISPLAY_MIN:
      minWProp = "3%";
      fSize = "20px";
      clipPath = "polygon( 0% 0%, 60% 0, 100% 50%, 60% 100%, 0% 100% )";
      break;

    case DISPLAY_MED1:
      minWProp = "9%";
      fSize = "10px";
      clipPath = "polygon( 0% 0%, 70% 0, 100% 50%, 70% 100%, 0% 100% )";
      break;

    case DISPLAY_MED2:
      minWProp = "24%";
      slFontSize = "100%";
      clipPath = "polygon( 0% 0%, 85% 0, 95% 50%, 85% 100%, 0% 100% )";
      break;

    case DISPLAY_LARGE:
      minWProp = "50%";
      slFontSize = "150%";
      clipPath = "polygon( 0% 0%, 85% 0, 95% 50%, 85% 100%, 0% 100% )";
      break;
  }

  var groups = document.getElementsByClassName( "setname" );
  for( var i = 0;i < groups.length;i++ )
    if( slFontSize )
    {
      groups[ i ].style.fontSize = slFontSize;
      groups[ i ].style.display = "block";
    }
    else
      groups[ i ].style.display = "none";

  for( var i = 0;i < acc.length;i++ )
  {
    acc[ i ].style.minWidth = minWProp;

    var strName;
    var prune = songNames[ i ][ 1 ] == '.' ? 0 : 1;
    if( disFormat == DISPLAY_MIN )
      strName = songNames[ i ].substr( 0, 1 + prune );
    else if( disFormat == DISPLAY_MED1 )
      strName = songNames[ i ].substr( 2 + prune, 10 + prune );
    else if( disFormat == DISPLAY_MED2 )
      strName = songNames[ i ].substr( 0, 20 );
    else
      strName = songNames[ i ];

    acc[ i ].innerHTML = strName;
    acc[ i ].style.fontSize = fSize;
    if( acc[ i ].classList.contains( "css_medleyStart" ) )
      acc[ i ].style.clipPath = clipPath;
  }
}

var scrollToElem; 

function expandSongNameByIndex( i )
{
  acc[ i ].innerHTML = songNames[ i ];
  acc[ i ].style.minWidth = "96%";
  acc[ i ].style.fontSize = "16px";
  if( acc[ i ].classList.contains( "css_medleyStart" ) )
    acc[ i ].style.clipPath = "polygon( 0% 0%, 85% 0, 95% 50%, 85% 100%, 0% 100% )";
}

function accordionClick( elem )
{
  currentSongIx = elem.accIndex;

  var wasOpen = elem.classList.contains( "active" );

  if( wasOpen && ( elem.classList.contains( "css_medleyCont" ) || elem.classList.contains( "css_medleyEnd" ) ) )
  {
    elem.scrollIntoView();
    return;
  }

  closeAll();
  displaySet( displayFormat ); 

  if( !wasOpen )
  {
    scrollToElem = elem;

    // Go to head of medley and open the whole thing.
    while( elem.classList.contains( "css_medleyCont" ) || elem.classList.contains( "css_medleyEnd" ) )
      elem = acc[ elem.accIndex - 1 ];

    // Open this one if it was closed before.
    inMedley = elem.classList.contains( "css_medleyStart" );

    while( elem )
    {
      elem.classList.add( "active" );

      // Make the song name visible in the compressed modes. Need to clear this when minimizing in displaySet() above
      expandSongNameByIndex( elem.accIndex );
      if( elem.accIndex < acc.length - 1 )
        expandSongNameByIndex( elem.accIndex + 1 );

      var panel = elem.nextElementSibling;
      setFontProperty(); // w/o this changing the font only applies to the open song. Possibly desirable.
      panel.style.display = "block";
  
      if( inMedley )
      {
        elem = acc[ elem.accIndex + 1 ];
        if( elem.classList.contains( "css_medleyEnd" ) )
          inMedley = false;
      }
      else
        elem = undefined;
    }
    scrollToElem.scrollIntoView();
    setTimeout( function() { scrollToElem.scrollIntoView(); }, 500 );
  }
}

var acc = document.getElementsByClassName( "accordion" );

songNames = [];

for( var i = 0;i < acc.length;i++ )
{
  songNames[ i ] = acc[ i ].innerHTML;
  acc[ i ].addEventListener( "click", function() { accordionClick( this ); } );
  acc[ i ].nextElementSibling.addEventListener( "click", function() { this.previousElementSibling.scrollIntoView(); } );
  acc[ i ].accIndex = i;
}
displaySet( DISPLAY_LARGE );
*/}.toString().slice( 14, -3 ) + "</" + "script> </" + "body> </html>" ); // little hack because certain tags confuse the browser.
    break;

  case 2:
    return( function(){/* 
<h2> Sample Player Creator </h2>
Create a new Sample List with 'New'. Add Groups with 'Add Group'. Click on names to rename.<br>
<br>
Drag samples from the Library in the right pane to the desired location. Samples and groups can be rearranged
by dragging. Delete things by dragging to the Trash.<br>
<br>
A library can be specified by appending "?library=http://x.y.z/???.json" to this URL.
    
*/}.toString().slice( 14, -3 ) + "</" + "script> </" + "body> </html>" ); // little hack because certain tags confuse the browser.
  break;
  }

  return undefined;
}

////////////////////// //////////////////////
// Sample List file mgmt
////////////////////// //////////////////////

function openSampleFile( e )
{
  var file = e.target.files[ 0 ];
  if( !file )
    return;
  var reader = new FileReader();
  reader.onload = function( e )
  {
    var lines = e.target.result.split( "\n" ); // Line 2->n is JSON of the setList
    var jsonPortion = ""; // setlist json beings with { in column 0 and ends with } in column 0.
    var firstLine = true;
    var success = false;

    for( line of lines )
    {
      if( firstLine )
      {
        firstLine = false; // first line is opening comment
        continue;
      }

      jsonPortion += line;
      if( line == "}" )
      {
        success = true; // found the end of json.
        break;
      }
    }
    if( success )
    {
      try
      {
        var parsed = JSON.parse( jsonPortion );
        curSampleConfig = parsed;
      }
      catch( error )
      {
        alert( error );
      }
    }
    else
      alert( "Unable to parse setlist" );

    genSampleConfigHTML();
  }

  reader.readAsText( file );
}

/////////////// /////////////// /////////////// /////////////// ///////////////
// Generate the config
/////////////// /////////////// /////////////// /////////////// ///////////////
function saveSampleConfig()
{
  var configData = JSON.stringify( curSampleConfig, null, "  " );

  var formData = new FormData();
  formData.append( "data", configData );

  var xhr = new XMLHttpRequest();
  xhr.open( 'post', serverURL + configFile );
  xhr.send( formData );

  slEditedFlag = false;
  genSampleConfigHTML();
  return true;
}

var helpState = false;
function toggleHelp()
{
  helpState = !helpState;
  var helpHtml = "";

  if( helpState )
    helpHtml = htmlConstStrings( 2 );

  var helpElem = document.getElementById( 'multiuse' );
  helpElem.innerHTML = helpHtml;
}

</script>
</body>
</html>